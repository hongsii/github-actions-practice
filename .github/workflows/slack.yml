name: slack-test
on:
  push:
    branches: master
    paths-ignore:
    - '**.md'
  deployment:

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    - uses: 8398a7/action-slack@v3
      name: start job
      if: always()
      with:
        status: custom
        author_name: '배포 알리미'
        fields: repo,commit,message,action,ref,job,took,workflow,eventName
        custom_payload: |
            {
              text: `Start ${process.env.AS_JOB} of ${process.env.AS_REPO}`
            }

    - name: Run task
      run: |
        echo "This job should notify to slack"
        ls
    - uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: custom
        author_name: '배포 알리미'
        fields: repo,commit,message,action,ref,job,took,workflow,eventName
        custom_payload: |
            {
              text: ('${{ job.status }}' === 'success' ? "✅ Successd" : '${{ job.status }}' === 'failure' ? "❌ Failed" : "✖️ Cancelled") + ` ${process.env.AS_JOB} of ${process.env.AS_REPO}`,
              attachments: [
                {
                  color: '${{ job.status }}' === 'success' ? "#00FF00" : '${{ job.status }}' === 'failure' ? "#FF0000" : "#505050",
                  blocks: [
                    {
                      type: "section",
                      fields: [
                        { type: "mrkdwn", text: `*repo:*\n${process.env.AS_REPO}` },
                        { type: "mrkdwn", text: `*branch:*\n${process.env.AS_REF}` },
                        { type: "mrkdwn", text: `*commit:*\n${process.env.AS_MESSAGE} (${process.env.AS_COMMIT})` },
                        { type: "mrkdwn", text: `*job:*\n${process.env.AS_WORKFLOW} -> ${process.env.AS_JOB}` },
                        { type: "mrkdwn", text: `*job event:*\n${process.env.AS_EVENT_NAME}` },
                        { type: "mrkdwn", text: `*elasped time:*\n${process.env.AS_TOOK}` },
                      ]
                    }
                  ]
                }
              ]
            }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # optional
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # required
        DEPLOY_TRIGGER_URL: ${{ secrets.DEPLOY_TRIGGER_URL }}
        DEPLOY_GITHUB_TOKEN: ${{ secrets.DEPLOY_GITHUB_TOKEN }}
